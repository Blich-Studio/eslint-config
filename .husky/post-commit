#!/bin/sh

# Get the last commit message from current branch
LAST_MSG=$(git log -1 --pretty=%B 2>/dev/null || echo "")

# Determine version bump from commit message
if echo "$LAST_MSG" | grep -qE "^(feat|feature)(\(.+\))?!:|^[A-Za-z]+(\(.+\))?!:|BREAKING CHANGE:"; then
  VERSION_TYPE="major"
elif echo "$LAST_MSG" | grep -qE "^feat(\(.+\))?:"; then
  VERSION_TYPE="minor"
elif echo "$LAST_MSG" | grep -qE "^fix(\(.+\))?:"; then
  VERSION_TYPE="patch"
else
  # No version bump for other commit types (chore, docs, style, refactor, etc.)
  exit 0
fi

# Get current version
CURRENT_VERSION=$(node -p "require('./package.json').version")

# Bump version using npm
npm version "$VERSION_TYPE" --no-git-tag-version --allow-same-version

NEW_VERSION=$(node -p "require('./package.json').version")

# Only stage if version changed
if [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
  git add package.json
  echo "✓ Version bumped: $CURRENT_VERSION → $NEW_VERSION ($VERSION_TYPE)"
fi
